## Практическое задание

**Цель практической работы**

Система состоит из двух сервисов с бизнес-логикой:
* Order Service.
* Payment Service.

Как выглядит создание заказа

Рассмотрим процесс успешного оформления заказа:
- От клиента приходит запрос по HTTP POST /order в Order Service.
- Создаётся заказ в статусе CREATED.
- В Payment Service проверяется баланс пользователя: достаточно ли средств на счету для оплаты.
- В Payment Service производится оплата со статусом APPROVED.
- В Payment Service создаётся транзакция о статусе оплаты заказа со статусом SUCCESSFUL.
- В Order Service заказ переходит в статус COMPLETED.



### Что нужно сделать

Каждый из этапов оформления заказа затрагивает разные сервисы, входящие в систему (либо Order Service, либо Payment Service). 
На некоторых этапах что-то может пойти не так и произойдёт ошибка. 
Как вы помните, в таком случае при реализации саги понадобится компенсирующая транзакция, которая позволит привести систему в консистентное состояние.

На каких этапах оформления заказа могут произойти ошибки?

Например, при попытке оплаты заказа на счету пользователя может не хватить средств.

В упрощённом варианте саги в данном задании не нужно создавать компенсирующие транзакции, 
однако надо сменить статус заказа на **FAILED** и создать запись об оплате со статусом **DECLINED**.

1.  Подключить в **order-service** библиотеку **Spring Cloud Stream**.

Так как сага будет создаваться на основе хореографии, необходимо добавить возможность взаимодействия с брокером сообщений для отправки и получения событий саги.
Будем использовать Spring Cloud Stream для работы с механизмом передачи сообщений.

Необходимо подключить следующие зависимости:
- 'org.springframework.cloud:spring-cloud-stream'
- 'org.springframework.cloud:spring-cloud-stream-binder-kafka'
- 'org.springframework.kafka:spring-kafka'

2. Добавить **OrderService** в **Order Service**:

**OrderService** должен:
- Сохранить order в БД со статусом **CREATED**.
- Вызвать метод process в **OrderProcessor**.

3. Добавить **OrderProcessor** в **Order Service**:

**OrderProcessor** должен создать **OrderCreatedEvent** и отправить его в топик **orders** в Kafka.


4. Добавить **OrderCreatedEventHandler** в **Payment Service**.

Стоит использовать интерфейс **EventHandler**:
```java
public interface EventHandler<T extends Event, R extends Event> {
    R handleEvent(T event);
}
```

**EventHandler** умеет:
- принимать входящие события;
- отправлять новые события.

**OrderCreatedEventHandler** должен:
- принять событие из топика orders в Kafka;
- запросить баланс пользователя из БД;
- проверить уровень баланса: достаточен ли он для выполнения заказа. Если да, то изменить баланс счёта;
- создать PaymentEvent со статусом APPROVED или DECLINED и отправить его в топик payments в Kafka.

4. Добавить PaymentEventHandler в Payment Service.

PaymentEventHandler должен:
- сохранить transaction в БД с данными из пришедшего **PaymentEvent**;
- создать событие **TransactionEvent** со статусом **SUCCESSFUL** или **UNSUCCESSFUL** и отправить его в топик **transactions** в Kafka.

4. Добавить **TransactionEventConsumer** в **Order Service**.

Стоит использовать интерфейс **EventConsumer**:
```java
public interface EventConsumer<T extends Event> {
    void consumeEvent(T event);
}
```

**EventConsumer** умеет:
- принимать входящие события.

**TransactionEventConsumer** должен:
- принять событие **TransactionEvent** и изменить статус заказа на **FAILED** или **COMPLETED**.

После выполнения задания у вас должна быть создана сага для процесса создания заказа. В качестве результата выполнения задания отправьте ссылку на GitLab с кодом.


### Критерии оценки задания

**Принято:**

- Выполнено задание практической работы.
- В задании учтены все требования: реализованы указанные компоненты Order Service и Payment Service.
- Все сервисы работают без ошибок, код компилируется.

**На доработку:** задание не выполнено, выполнено неточно или частично.

### Как отправить работу на проверку

Сдайте работу через систему контроля версий Git сервиса Skillbox GitLab. 
В форме ниже напишите «Сделано» и прикрепите ссылку на репозиторий, а также необходимые скриншоты. Ссылки на реплит оставлять не нужно.
